
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================================================
    // Helper Functions
    // =====================================================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user';
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // =====================================================================
    // Users Collection
    // =====================================================================
    match /users/{userId} {
      allow read: if isAdmin() || (isSignedIn() && isOwner(userId));
      
      // Allow user creation (signup)
      allow create: if isSignedIn() 
                    && isOwner(userId)
                    && request.resource.data.role == 'user'
                    && request.resource.data.createdAt is timestamp;
      
      // Admins can update any user, users can only update their own name
      allow update: if isAdmin() || 
                     (isUser() && isOwner(userId) && request.resource.data.keys().hasOnly(['name']));

      allow delete: if isAdmin();
    }

    // =====================================================================
    // Transactions Collection
    // =====================================================================
    match /transactions/{transactionId} {
      allow read: if isAdmin();
      
      // Only the user involved in the transaction can create it
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Transactions are immutable
      allow update, delete: if false;
    }

    // =====================================================================
    // Books Collection
    // =====================================================================
    match /books/{bookId} {
      allow read: if isSignedIn();

      // --- CREATE ---
      allow create: if 
        // Admins can add books directly
        (isAdmin() && request.resource.data.status in ['available', 'maintenance', 'lost']) ||
        // Users can submit a donation request
        (isUser() && request.resource.data.status == 'donated_pending_approval' 
                  && request.resource.data.donatedBy.userId == request.auth.uid
                  && request.resource.data.donatedBy.date == request.time);

      // --- UPDATE ---
      allow update: if 
        // Admins have broad update permissions
        isAdmin() ||
        
        // Use case: User requests to issue a book
        ( isUser() && resource.data.status in ['available', 'donated_approved']
            && request.resource.data.status == 'issue_requested'
            && request.resource.data.issueDetails.userId == request.auth.uid
            && request.resource.data.issueDetails.issueDate == request.time
            && request.resource.data.issueDetails.dueDate == null
        ) ||
        
        // Use case: User requests to return their issued book
        ( isUser() && resource.data.status == 'issued'
            && resource.data.issueDetails.userId == request.auth.uid
            && request.resource.data.status == 'return_requested'
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
        ) ||
        
        // Use case: User renews a book (only dueDate changes)
        ( isUser() && resource.data.status == 'issued'
            && resource.data.issueDetails.userId == request.auth.uid
            && resource.data.issueDetails.dueDate < request.time // Simplified renewal rule
            && request.resource.data.issueDetails.dueDate > resource.data.issueDetails.dueDate
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['issueDetails.dueDate'])
        );
      
      // --- DELETE ---
      allow delete: if isAdmin();
    }
  }
}
