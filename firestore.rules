rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isUser() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'user';
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- Users Collection Rules ---
    match /users/{userId} {
      // READ: Admins can read all user profiles. Users can read their own.
      allow read: if isAdmin() || (isUser() && isOwner(userId));
      
      // CREATE: A user can create their own user document (e.g., on signup).
      // The role must be 'user', and the UID must match.
      allow create: if isSignedIn() && isOwner(userId)
                    && request.resource.data.role == 'user'
                    // ensure required fields are present
                    && 'email' in request.resource.data
                    && 'createdAt' in request.resource.data
                    && request.resource.data.createdAt == request.time;
      
      // UPDATE: Admins can update any user. Users can only update their own `name`.
      // Roles cannot be changed by users.
      allow update: if isAdmin() || (isUser() && isOwner(userId)
                    && request.resource.data.name == resource.data.name
                    && request.resource.data.role == resource.data.role); // Can't change role
      
      // DELETE: Only admins can delete user documents.
      allow delete: if isAdmin();
    }

    // --- Books Collection Rules ---
    match /books/{bookId} {
      // READ: Any signed-in user can read book data.
      allow read: if isSignedIn();
      
      // CREATE: 
      // 1. Admins can create books with any valid status.
      // 2. Users can only create books for donation (`donated_pending_approval`).
      allow create: if (isAdmin() && request.resource.data.status in ['available', 'maintenance', 'lost'])
                    || (isUser() && request.resource.data.status == 'donated_pending_approval'
                        && request.resource.data.donatedBy.userId == request.auth.uid
                        && request.resource.data.donatedBy.date == request.time);
      
      // UPDATE: Complex logic for different state transitions.
      allow update: if 
        // Admins can perform any update.
        isAdmin() ||
        
        // Users can request to issue an available book.
        // Transition: 'available' -> 'issue_requested'
        (isUser() && resource.data.status == 'available'
          && request.resource.data.status == 'issue_requested'
          && request.resource.data.issueDetails.userId == request.auth.uid
          && request.resource.data.issueDetails.issueDate == request.time) ||
          
        // Users can renew a book they have issued (if not overdue).
        (isUser() && resource.data.status == 'issued' 
          && request.resource.data.status == 'issued'
          && resource.data.issueDetails.userId == request.auth.uid
          && resource.data.issueDetails.dueDate <= request.time == false // cannot renew if overdue
          && request.resource.data.issueDetails.dueDate > resource.data.issueDetails.dueDate) ||

        // Users cannot return books themselves anymore, only admins can.
        // This is handled by admin permission above.
        false;

      // DELETE: Only admins can delete books.
      allow delete: if isAdmin();
    }
    
    // --- Transactions Collection Rules ---
    match /transactions/{transactionId} {
      // READ: Admins can read all transactions.
      allow read: if isAdmin();

      // WRITE: 
      // 1. Admins can create any transaction record.
      // 2. Users can only create transactions where they are the subject (`userId`).
      allow write: if isAdmin() || (isUser() && request.resource.data.userId == request.auth.uid);
    }
  }
}
