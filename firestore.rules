rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper Functions
    // ===============================================
    
    // Get current user's role from the 'users' collection
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    // Check if the user is an admin
    function isAdmin() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'admin';
    }
    
    // Check if the user is a standard user
    function isUser() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'user';
    }
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // USERS Collection Rules
    // ===============================================
    match /users/{userId} {
    
      // CREATE: Allow a user to create their own document (e.g., during signup)
      allow create: if isSignedIn() 
                      && isOwner(userId)
                      && request.resource.data.role == 'user'
                      && request.resource.data.createdAt == request.time;
      
      // READ: Admins can read any user profile. Users can read their own profile.
      allow get: if isAdmin() || (isSignedIn() && isOwner(userId));
      allow list: if isAdmin(); // Only admins can list all users
      
      // UPDATE: Admins can update any profile. Users can only update their own name.
      allow update: if isAdmin() || 
                      (isUser() && isOwner(userId) && request.resource.data.keys().hasOnly(['name']));
      
      // DELETE: Only admins can delete user documents (Firestore record, not Auth user)
      allow delete: if isAdmin();
    }
    
    // BOOKS Collection Rules
    // ===============================================
    match /books/{bookId} {
    
      // READ: Any authenticated user can read book data.
      allow get, list: if isSignedIn();

      // CREATE:
      // Admins can add books with any valid status.
      // Users can only add books via donation (status: 'donated_pending_approval')
      allow create: if (isAdmin() && request.resource.data.status in ['available', 'maintenance', 'lost'])
                      || (isUser() 
                          && request.resource.data.status == 'donated_pending_approval'
                          && request.resource.data.donatedBy.userId == request.auth.uid
                          && request.resource.data.donatedBy.date == request.time);
                          
      // UPDATE: Complex logic for different update scenarios
      allow update: if isAdmin() // Admins can perform any valid update.
                      || 
                      // User requests to issue a book
                      (isUser() 
                        && request.resource.data.status == 'issue_requested'
                        && resource.data.status == 'available' // Can only request available books
                        && request.resource.data.issueDetails.userId == request.auth.uid
                        && request.resource.data.issueDetails.issueDate == request.time)
                      ||
                      // User requests to return a book
                      (isUser()
                        && isOwner(resource.data.issueDetails.userId)
                        && request.resource.data.status == 'return_requested'
                        && resource.data.status == 'issued')
                      ||
                      // User renews a book
                      (isUser()
                        && isOwner(resource.data.issueDetails.userId)
                        && resource.data.status == 'issued'
                        && request.resource.data.issueDetails.dueDate > resource.data.issueDetails.dueDate // New due date must be later
                      );

      // DELETE: Only admins can delete books.
      allow delete: if isAdmin();
    }
    
    // TRANSACTIONS Collection Rules
    // ===============================================
    match /transactions/{transactionId} {
    
      // READ: Only admins can read the full transaction log.
      allow get, list: if isAdmin();
      
      // CREATE:
      // A user can create a transaction if they are the one associated with it.
      // An admin can create any transaction (e.g. issuing a book from the admin panel)
      allow create: if (isSignedIn() && request.resource.data.userId == request.auth.uid && request.resource.data.timestamp == request.time) 
                      || isAdmin();
                      
      // UPDATE, DELETE: Transactions should be immutable.
      allow update, delete: if false;
    }
  }
}
